<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= titulo %></title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Estilo para a barra de rolagem dos selects múltiplos */
        #projetosAvaliador, #criteriosProjeto {
            max-height: 200px;
            overflow-y: auto; /* Garante a rolagem para selects múltiplos */
            border-radius: 0.375rem; /* rounded-md */
            border-color: #d1d5db; /* gray-300 */
        }
        .modal-full {
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
        }

        /* Estilos do Sidebar */
        .sidebar {
            width: 250px;
            min-width: 250px; /* Garante que não encolha abaixo disso */
            transition: all 0.3s ease;
            transform: translateX(0);
        }
        .sidebar.collapsed {
            width: 64px; /* w-16 em Tailwind */
            min-width: 64px;
            transform: translateX(0); /* Permanece visível, apenas menor */
        }
        /* Para telas menores, o sidebar deve sumir ou ficar como overlay */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                height: 100%;
                z-index: 1000;
                transform: translateX(-100%); /* Esconde completamente por padrão */
            }
            .sidebar.show {
                transform: translateX(0); /* Mostra quando ativado */
            }
            .content-area {
                margin-left: 0 !important; /* Reseta a margem para telas pequenas */
            }
            .main-content {
                width: 100%; /* Ocupa toda a largura */
            }
        }

        .content-area {
            transition: margin-left 0.3s ease;
        }
        .sidebar:not(.collapsed) + .content-area {
            margin-left: 250px; /* Largura do sidebar expandido */
        }
        .sidebar.collapsed + .content-area {
            margin-left: 64px; /* Largura do sidebar colapsado */
        }

        /* Estilos para links do sidebar */
        .sidebar a, .sidebar button {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: #d1d5db; /* gray-300 */
            text-decoration: none;
            border-radius: 8px;
            margin: 4px 0;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .sidebar a:hover, .sidebar button:hover {
            background-color: #4b5563; /* gray-700 */
            color: #e5e7eb; /* gray-200 */
        }
        .sidebar a.active, .sidebar button.active {
            background-color: #3b82f6; /* blue-600 */
            color: white;
            font-weight: 700;
        }
        .sidebar .icon-wrapper {
            width: 24px; /* Garante que o ícone tenha um tamanho fixo */
            text-align: center;
            margin-right: 12px;
        }
        .sidebar.collapsed .link-text {
            display: none; /* Esconde o texto quando colapsado */
        }
        .sidebar.collapsed .icon-wrapper {
            margin-right: 0;
            width: auto; /* Permite que o ícone se ajuste */
            justify-content: center; /* Centraliza o ícone quando colapsado */
        }
        /* Ajuste para o botão de toggle */
        .sidebar-toggle-button {
            position: absolute;
            top: 1rem;
            right: 1rem; /* Ajustado para estar dentro do sidebar */
            z-index: 1001; /* Acima do sidebar */
            background-color: #4b5563; /* gray-700 */
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: right 0.3s ease;
        }
        .sidebar.collapsed .sidebar-toggle-button {
             right: 12px; /* Ajusta a posição para quando colapsado */
        }
         @media (max-width: 768px) {
            .sidebar-toggle-button {
                left: 1rem; /* Move para a esquerda na tela pequena */
                right: auto;
                top: 1rem;
            }
        }
    </style>
</head>
<body class="bg-gray-50 flex min-h-screen">
    <%
        // Inicialização de variáveis para evitar 'is not defined'
        if (!feiras) { feiras = []; }
        if (!feiraAtual) { feiraAtual = {}; }
        if (!projetos) { projetos = []; }
        if (!categorias) { categorias = []; }
        if (!criterios) { criterios = []; } 
        if (!avaliadores) { avaliadores = []; }
        if (!avaliacoes) { avaliacoes = []; }
        if (!escolas) { escolas = []; }
        if (!totalProjetos) { totalProjetos = 0; }
        if (!totalAvaliadores) { totalAvaliadores = 0; }
        if (!projetosAvaliadosCompletosCount) { projetosAvaliadosCompletosCount = 0; }
        if (!projetosPendentesAvaliacaoCount) { projetosPendentesAvaliacaoCount = 0; }
        if (!mediaGeralAvaliacoes) { mediaGeralAvaliacoes = 'N/A'; }
        if (!projetosPorCategoria) { projetosPorCategoria = {}; }
        if (!relatorioFinalPorProjeto) { relatorioFinalPorProjeto = {}; }
    %>

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar bg-gray-800 text-gray-300 p-4 shadow-lg relative flex flex-col">
        <div class="p-4 text-center border-b border-gray-700 mb-4 flex justify-between items-center">
            <h1 class="text-2xl font-extrabold tracking-tight text-white link-text">Painel Admin</h1>
            <button id="sidebarToggle" class="text-gray-400 hover:text-white focus:outline-none focus:ring-2 focus:ring-gray-600 rounded-md p-1">
                <i class="fas fa-bars text-xl"></i>
            </button>
        </div>

        <nav class="flex-grow">
            <ul class="space-y-1">
                <li>
                    <a href="#" class="sidebar-link <% if(activeTab === 'dashboard-geral') { %>active<% } %>" data-tab="dashboard-geral">
                        <span class="icon-wrapper"><i class="fas fa-tachometer-alt"></i></span>
                        <span class="link-text">Visão Geral</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="sidebar-link <% if(activeTab === 'projetos') { %>active<% } %>" data-tab="projetos">
                        <span class="icon-wrapper"><i class="fas fa-lightbulb"></i></span>
                        <span class="link-text">Projetos</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="sidebar-link <% if(activeTab === 'categorias') { %>active<% } %>" data-tab="categorias">
                        <span class="icon-wrapper"><i class="fas fa-tags"></i></span>
                        <span class="link-text">Categorias</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="sidebar-link <% if(activeTab === 'criterios') { %>active<% } %>" data-tab="criterios">
                        <span class="icon-wrapper"><i class="fas fa-clipboard-list"></i></span>
                        <span class="link-text">Critérios</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="sidebar-link <% if(activeTab === 'avaliadores') { %>active<% } %>" data-tab="avaliadores">
                        <span class="icon-wrapper"><i class="fas fa-user-tie"></i></span>
                        <span class="link-text">Avaliadores</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="sidebar-link <% if(activeTab === 'feiras') { %>active<% } %>" data-tab="feiras">
                        <span class="icon-wrapper"><i class="fas fa-calendar-alt"></i></span>
                        <span class="link-text">Feiras</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="sidebar-link <% if(activeTab === 'relatorios') { %>active<% } %>" data-tab="relatorios">
                        <span class="icon-wrapper"><i class="fas fa-file-pdf"></i></span>
                        <span class="link-text">Relatórios</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="sidebar-link <% if(activeTab === 'tab-configuracoes') { %>active<% } %>" data-tab="tab-configuracoes">
                        <span class="icon-wrapper"><i class="fas fa-cog"></i></span>
                        <span class="link-text">Configurações</span>
                    </a>
                </li>
            </ul>
        </nav>
        
        <div class="mt-auto pt-4 border-t border-gray-700">
            <form action="/admin/logout" method="POST" class="w-full">
                <button type="submit" class="w-full bg-red-700 hover:bg-red-800 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                    <span class="icon-wrapper"><i class="fas fa-sign-out-alt"></i></span>
                    <span class="link-text">Sair</span>
                </button>
            </form>
        </div>
    </aside>

    <!-- Main Content Area -->
    <div id="contentArea" class="flex-grow p-6 bg-gray-50 main-content">
        <header class="bg-white p-4 shadow-md rounded-lg mb-6">
            <div class="container mx-auto flex justify-between items-center">
                <h2 class="text-3xl font-extrabold text-gray-800">
                    Feira Atual: <span class="text-blue-600"><%= feiraAtual.nome || 'Nenhuma Feira Ativa' %></span>
                    <small class="text-gray-500 text-lg ml-2">
                        (<%= feiraAtual.status ? (feiraAtual.status === 'ativa' ? 'Ativa' : 'Arquivada') : 'Não Definida' %>)
                        <%= feiraAtual.inicioFeira && feiraAtual.fimFeira ? ` (${new Date(feiraAtual.inicioFeira).toLocaleDateString('pt-BR')} - ${new Date(feiraAtual.fimFeira).toLocaleDateString('pt-BR')})` : '' %>
                    </small>
                </h2>
            </div>
        </header>

        <div class="mb-6 bg-white p-4 rounded-lg shadow-sm border border-gray-200">
            <form method="GET" action="/admin/dashboard" class="flex flex-wrap items-center gap-4">
                <label for="feiraSelecionada" class="text-base font-medium text-gray-700">Selecionar Feira:</label>
                <select name="feiraId" id="feiraSelecionada" class="flex-grow md:flex-grow-0 border border-gray-300 px-4 py-2 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                    <option value="">-- Selecione uma Feira --</option>
                    <% feiras.forEach(f => { %>
                        <option value="<%= f._id %>" <%= feiraAtual._id && feiraAtual._id.toString() === f._id.toString() ? 'selected' : '' %>>
                            <%= f.nome %> - <%= f.status === 'arquivada' ? 'Arquivada' : 'Ativa' %>
                        </option>
                    <% }) %>
                </select>
                <button type="submit" class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition duration-300 ease-in-out shadow-md w-full md:w-auto">
                    <i class="fas fa-sync-alt mr-2"></i>Carregar
                </button>
            </form>
        </div>

   <!---   <div class="tab-content p-6 bg-white rounded-lg shadow-inner border border-gray-200 <% if(activeTab !== 'dashboard-geral') { %>hidden<% } %>" id="dashboard-geral" role="tabpanel" aria-labelledby="dashboard-geral-tab">
  <%- include('dashboard-geral-content', {
      projetosPorCategoria: projetosPorCategoria,
      avaliadores: avaliadores,
      relatorioFinalPorProjeto: relatorioFinalPorProjeto,
      criteriosOficiais: criterios,
      formatarData: formatarDatasParaInput
  }) %>
</div>-->

           
            <!-- ABA: PROJETOS -->
            <div class="tab-content p-6 bg-white rounded-lg shadow-inner border border-gray-200 hidden" id="projetos" role="tabpanel" aria-labelledby="projetos-tab">
                <button id="btnAbrirModalProjeto" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg mb-6 shadow-md transition duration-300 ease-in-out">
                    <i class="fas fa-plus-circle mr-2"></i>Adicionar Novo Projeto
                </button>

                <div class="overflow-x-auto bg-white rounded-lg shadow-md border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Título</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Turma</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <% Object.keys(projetosPorCategoria).sort().forEach(nomeCategoria => { %>
                                <tr class="bg-gray-50">
                                    <td colspan="3" class="py-2 px-4 text-left font-extrabold text-lg text-blue-700">
                                        <%= nomeCategoria %>
                                    </td>
                                </tr>
                                <% projetosPorCategoria[nomeCategoria].forEach(projeto => { %>
                                    <tr class="hover:bg-gray-100 transition duration-150 ease-in-out">
                                        <td class="py-3 px-4 text-gray-800"><%= projeto.titulo %></td>
                                        <td class="py-3 px-4 text-gray-800"><%= projeto.turma || 'Não informado' %></td>
                                        <td class="py-3 px-4 whitespace-nowrap">
                                            <button class="btn-editar-projeto bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1.5 px-3 rounded-md text-sm mr-2 shadow-sm transition duration-300 ease-in-out"
                                                data-id="<%= projeto._id %>"
                                                data-titulo="<%= projeto.titulo %>"
                                                data-descricao="<%= projeto.descricao %>"
                                                data-categoria-id="<%= projeto.categoria ? projeto.categoria._id : '' %>"
                                                data-criterios="<%= projeto.criterios && projeto.criterios.length > 0 ? projeto.criterios.map(c => c._id).join(',') : '' %>"
                                                data-turma="<%= projeto.turma %>">
                                                <i class="fas fa-edit mr-1"></i>Editar
                                            </button>
             
                                            <form method="POST" action="/admin/projetos/<%= projeto._id %>?_method=DELETE" class="inline-block" onsubmit="return confirm('Tem certeza que deseja deletar este projeto?');">
                                                <input type="hidden"  name="_method" value="DELETE">
                                                <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1.5 px-3 rounded-md text-sm shadow-sm transition duration-300 ease-in-out">Deletar</button>
                                            </form>
                                        </td>
                                    </tr>
                                <% }) %>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- FIM ABA: PROJETOS -->

            <!-- ABA: CATEGORIAS -->
            <div class="tab-content p-6 bg-white rounded-lg shadow-inner border border-gray-200 hidden" id="categorias" role="tabpanel" aria-labelledby="categorias-tab">
                <button id="btnAbrirModalCategoria" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg mb-6 shadow-md transition duration-300 ease-in-out">
                    <i class="fas fa-plus-circle mr-2"></i>Adicionar Nova Categoria
                </button>

                <div class="overflow-x-auto bg-white rounded-lg shadow-md border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nome da Categoria</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% categorias.forEach(categoria => { %>
                                <tr class="hover:bg-gray-100 transition duration-150 ease-in-out">
                                    <td class="py-3 px-4 text-gray-800"><%= categoria.nome %></td>
                                    <td class="py-3 px-4 whitespace-nowrap">
                                        <button class="btn-editar-categoria bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1.5 px-3 rounded-md text-sm mr-2 shadow-sm transition duration-300 ease-in-out"
                                                data-id="<%= categoria._id %>" 
                                                data-nome="<%= categoria.nome %>">
                                            <i class="fas fa-edit mr-1"></i> Editar
                                        </button>
                                        <form method="POST" action="/admin/categorias/<%= categoria._id %>/excluir?_method=DELETE" class="inline-block" onsubmit="return confirm('Tem certeza que deseja deletar esta categoria?');">
                                            <input type="hidden" name="_method" value="DELETE">
                                            <button type="submit"  class="bg-red-600 hover:bg-red-700 text-white font-bold py-1.5 px-3 rounded-md text-sm shadow-sm transition duration-300 ease-in-out">
                                                <i class="fas fa-trash-alt mr-1"></i>Excluir
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- FIM ABA: CATEGORIAS -->

            <!-- ABA: CRITÉRIOS -->
            <div class="tab-content p-6 bg-white rounded-lg shadow-inner border border-gray-200 hidden" id="criterios" role="tabpanel" aria-labelledby="criterios-tab">
                <button id="btnAbrirModalCriterio" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg mb-6 shadow-md transition duration-300 ease-in-out">
                    <i class="fas fa-plus-circle mr-2"></i>Adicionar Novo Critério
                </button>

                <div class="overflow-x-auto bg-white rounded-lg shadow-md border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nome do Critério</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Peso</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Observações</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <% criterios.forEach(criterio => { %>
                                <tr class="hover:bg-gray-100 transition duration-150 ease-in-out">
                                    <td class="py-3 px-4 text-gray-800"><%= criterio.nome %></td>
                                    <td class="py-3 px-4 text-gray-800"><%= criterio.peso %></td>
                                    <td class="py-3 px-4 text-gray-800"><%= criterio.observacao || 'Nenhuma' %></td>
                                    <td class="py-3 px-4 whitespace-nowrap">
                                        <button class="btn-editar-criterio bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1.5 px-3 rounded-md text-sm mr-2 shadow-sm transition duration-300 ease-in-out"
                                            data-id="<%= criterio._id %>"
                                            data-nome="<%= criterio.nome %>"
                                            data-peso="<%= criterio.peso %>"
                                            data-observacao="<%= criterio.observacao || '' %>">
                                            <i class="fas fa-edit mr-1"></i>Editar
                                        </button>                                        
                                        <form method="POST" action="/admin/criterios/<%= criterio._id %>/excluir?_method=DELETE" class="inline-block" onsubmit="return confirm('Tem certeza que deseja deletar este critério?');">
                                            <input type="hidden"  name="_method" value="DELETE">
                                            <button type="submit"  class="bg-red-600 hover:bg-red-700 text-white font-bold py-1.5 px-3 rounded-md text-sm shadow-sm transition duration-300 ease-in-out">
                                                <i class="fas fa-trash-alt mr-1"></i>Excluir
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- FIM ABA: CRITÉRIOS -->

            <!-- ABA: AVALIADORES -->
            <div class="tab-content p-6 bg-white rounded-lg shadow-inner border border-gray-200 hidden" id="avaliadores" role="tabpanel" aria-labelledby="avaliadores-tab">
                <button id="btnAbrirModalAvaliador" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg mb-6 shadow-md transition duration-300 ease-in-out">
                    <i class="fas fa-plus-circle mr-2"></i>Adicionar Novo Avaliador
                </button>

                <div class="overflow-x-auto bg-white rounded-lg shadow-md border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nome</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Email</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">PIN</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Ativo</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Projetos Atribuídos</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <% avaliadores.forEach(avaliador => { %>
                                <tr class="hover:bg-gray-100 transition duration-150 ease-in-out">
                                    <td class="py-3 px-4 text-gray-800"><%= avaliador.nome %></td>
                                    <td class="py-3 px-4 text-gray-800"><%= avaliador.email %></td>
                                    <td class="py-3 px-4 text-gray-800"><%= avaliador.pin %></td>
                                    <td class="py-3 px-4">
                                        <span class="px-2 py-1 rounded-full text-xs font-semibold
                                            <%= avaliador.ativo ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800' %>">
                                            <%= avaliador.ativo ? 'Sim' : 'Não' %>
                                        </span>
                                    </td>
                                    <td class="py-3 px-4">
                                        <% if (avaliador.projetosAtribuidos && avaliador.projetosAtribuidos.length > 0) { %>
                                            <% avaliador.projetosAtribuidos.forEach(projeto => { %>
                                                <span class="inline-block bg-indigo-100 text-indigo-800 text-xs font-semibold mr-1 mb-1 px-2.5 py-0.5 rounded-full dark:bg-indigo-200 dark:text-indigo-900"><%= projeto.titulo %></span>
                                            <% }) %>
                                        <% } else { %>
                                            <span class="text-gray-500">Nenhum</span>
                                        <% } %>
                                    </td>
                                    <td class="py-3 px-4 whitespace-nowrap">
                                        <button class="btn-editar-avaliador bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1.5 px-3 rounded-md text-sm mr-2 shadow-sm transition duration-300 ease-in-out"
                                            data-id="<%= avaliador._id %>"
                                            data-nome="<%= avaliador.nome %>"
                                            data-email="<%= avaliador.email %>"
                                            data-pin="<%= avaliador.pin %>"
                                            data-ativo="<%= avaliador.ativo %>"
                                            data-projetos="<%= avaliador.projetosAtribuidos.map(p => p._id).join(',') %>">
                                            <i class="fas fa-edit mr-1"></i>Editar
                                        </button>
                                        <form action="/admin/avaliadores/<%= avaliador._id %>/excluir" method="POST" class="inline-block" onsubmit="return confirm('Tem certeza que deseja deletar este avaliador?');">
                                            <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1.5 px-3 rounded-md text-sm shadow-sm transition duration-300 ease-in-out">
                                                <i class="fas fa-trash-alt mr-1"></i>Deletar
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- FIM ABA: AVALIADORES -->

            <!-- ABA: FEIRAS -->
            <div class="tab-content p-6 bg-white rounded-lg shadow-inner border border-gray-200 hidden" id="feiras" role="tabpanel" aria-labelledby="feiras-tab">
                <button id="btnAbrirModalFeira" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg mb-6 shadow-md transition duration-300 ease-in-out">
                    <i class="fas fa-plus-circle mr-2"></i>Adicionar Nova Feira
                </button>

                <div class="overflow-x-auto bg-white rounded-lg shadow-md border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nome da Feira</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Início</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Término</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Status</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <% feiras.forEach(f => { %>
  <tr class="hover:bg-gray-100 transition duration-150 ease-in-out">
    <td class="py-3 px-4 text-gray-800"><%= f.nome %></td>
    <td class="py-3 px-4 text-gray-800"><%= f.inicioFeira ? formatarDatasParaInput(f.inicioFeira) : 'N/A' %></td>
    <td class="py-3 px-4 text-gray-800"><%= f.fimFeira ? formatarDatasParaInput(f.fimFeira) : 'N/A' %></td>
    <td class="py-3 px-4">
      <span class="px-2 py-1 rounded-full text-xs font-semibold
        <%= f.status === 'ativa' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800' %>">
        <%= f.status === 'ativa' ? 'Ativa' : 'Arquivada' %>
      </span>
    </td>
    <td class="py-3 px-4 whitespace-nowrap">
      <button class="btn-editar-feira bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1.5 px-3 rounded-md text-sm mr-2 shadow-sm transition duration-300 ease-in-out"
        data-id="<%= f._id %>"
        data-nome="<%= f.nome %>"
        data-inicio="<%= f.inicioFeira ? formatarDatasParaInput(f.inicioFeira) : '' %>"
        data-fim="<%= f.fimFeira ? formatarDatasParaInput(f.fimFeira) : '' %>"
        data-status="<%= f.status %>">
        <i class="fas fa-edit mr-1"></i>Editar
      </button>

      <form method="POST" action="/admin/feiras/excluir" onsubmit="return confirm('Deseja realmente excluir esta feira?')" class="inline">
        <input type="hidden" name="feiraId" value="<%= f._id %>">
        <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1.5 px-3 rounded-md text-sm shadow-sm transition duration-300 ease-in-out">
          <i class="fas fa-trash-alt mr-1"></i>Excluir
        </button>
      </form>
    </td>
  </tr>
<% }) %>

                        </tbody>
                    </table>
                </div>
            </div>
            <!-- FIM ABA: FEIRAS -->

            <!-- ABA DE RELATÓRIOS -->
            <div class="tab-content p-6 bg-white rounded-lg shadow-inner border border-gray-200 hidden" id="relatorios" role="tabpanel" aria-labelledby="relatorios-tab">
                <h3 class="text-2xl font-bold mb-5 text-gray-700">Relatórios Gerenciais</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <a href="/admin/relatorio-consolidado/pdf" target="_blank" class="block p-6 bg-white rounded-lg shadow-md hover:shadow-lg transition duration-300 ease-in-out text-center">
                        <i class="fas fa-file-invoice text-indigo-600 text-4xl mb-3"></i>
                        <h4 class="text-lg font-semibold text-gray-800">Relatório Consolidado</h4>
                        <p class="text-sm text-gray-600">Gera um relatório detalhado de projetos e avaliações.</p>
                    </a>
                    <a href="/admin/avaliacoes/pdf" target="_blank" class="block p-6 bg-white rounded-lg shadow-md hover:shadow-lg transition duration-300 ease-in-out text-center">
                        <i class="fas fa-file-alt text-blue-600 text-4xl mb-3"></i>
                        <h4 class="text-lg font-semibold text-gray-800">Avaliações Completas</h4>
                        <p class="text-sm text-gray-600">Gera um PDF com detalhes de todas as avaliações.</p>
                    </a>
                    <a href="/admin/projetos-sem-avaliacao/pdf" target="_blank" class="block p-6 bg-white rounded-lg shadow-md hover:shadow-lg transition duration-300 ease-in-out text-center">
                        <i class="fas fa-exclamation-triangle text-orange-600 text-4xl mb-3"></i>
                        <h4 class="text-lg font-semibold text-gray-800">Projetos Sem Avaliação</h4>
                        <p class="text-sm text-gray-600">Lista de projetos que ainda não foram avaliados.</p>
                    </a>
                    <a href="/admin/ranking-categorias/pdf" target="_blank" class="block p-6 bg-white rounded-lg shadow-md hover:shadow-lg transition duration-300 ease-in-out text-center">
                        <i class="fas fa-trophy text-purple-600 text-4xl mb-3"></i>
                        <h4 class="text-lg font-semibold text-gray-800">Ranking por Categoria</h4>
                        <p class="text-sm text-gray-600">Classificação de projetos por categoria.</p>
                    </a>
                    <a href="/admin/resumo-avaliadores/pdf" target="_blank" class="block p-6 bg-white rounded-lg shadow-md hover:shadow-lg transition duration-300 ease-in-out text-center">
                        <i class="fas fa-users text-green-600 text-4xl mb-3"></i>
                        <h4 class="text-lg font-semibold text-gray-800">Resumo de Avaliadores</h4>
                        <p class="text-sm text-gray-600">Status e atividades dos avaliadores.</p>
                    </a>
                    <a href="/admin/resultados-finais/pdf" target="_blank" class="block p-6 bg-white rounded-lg shadow-md hover:shadow-lg transition duration-300 ease-in-out text-center">
                        <i class="fas fa-chart-bar text-red-600 text-4xl mb-3"></i>
                        <h4 class="text-lg font-semibold text-gray-800">Resultados Finais</h4>
                        <p class="text-sm text-gray-600">Relatório de resultados finais dos projetos.</p>
                    </a>
                </div>
            </div>
            <!-- FIM DA ABA DE RELATÓRIOS -->

            <!-- ABA: CONFIGURAÇÕES -->
            <div class="tab-content p-6 bg-white rounded-lg shadow-inner border border-gray-200 hidden" id="tab-configuracoes" role="tabpanel" aria-labelledby="tab-configuracoes-tab">
                <h3 class="text-2xl font-bold mb-5 text-gray-700">Configurações da Feira</h3>

                <div class="mb-6 bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h4 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-3">Informações da Feira Atual</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="nomeFeiraDisplay" class="block text-sm font-medium text-gray-600 mb-1">Nome da Feira:</label>
                            <p id="nomeFeiraDisplay" class="mt-1 p-3 border border-gray-200 rounded-md bg-gray-50 text-gray-800 font-medium"><%= feiraAtual.nome || 'N/A' %></p>
                        </div>
                        <div>
                            <label for="statusFeiraDisplay" class="block text-sm font-medium text-gray-600 mb-1">Status:</label>
                            <p id="statusFeiraDisplay" class="mt-1 p-3 border border-gray-200 rounded-md bg-gray-50 text-gray-800 font-medium">
                                <%= feiraAtual.status ? (feiraAtual.status === 'ativa' ? 'Ativa' : 'Arquivada') : 'N/A' %>
                            </p>
                        </div>
                        <div>
                            <label for="criadaEmDisplay" class="block text-sm font-medium text-gray-600 mb-1">Criada Em:</label>
                            <p id="criadaEmDisplay" class="mt-1 p-3 border border-gray-200 rounded-md bg-gray-50 text-gray-800 font-medium"><%= feiraAtual.createdAt ? formatarDatasParaInput(feiraAtual.createdAt) : 'N/A' %></p>
                        </div>
                        <div>
                            <label for="inicioFeiraDisplay" class="block text-sm font-medium text-gray-600 mb-1">Início da Feira:</label>
                            <p id="inicioFeiraDisplay" class="mt-1 p-3 border border-gray-200 rounded-md bg-gray-50 text-gray-800 font-medium"><%= feiraAtual.inicioFeira ? formatarDatasParaInput(feiraAtual.inicioFeira) : 'Não definido' %></p>
                        </div>
                        <div>
                            <label for="fimFeiraDisplay" class="block text-sm font-medium text-gray-600 mb-1">Fim da Feira:</label>
                            <p id="fimFeiraDisplay" class="mt-1 p-3 border border-gray-200 rounded-md bg-gray-50 text-gray-800 font-medium"><%= feiraAtual.fimFeira ? formatarDatasParaInput(feiraAtual.fimFeira) : 'Não definido' %></p>
                        </div>
                        <% if (feiraAtual.arquivadaEm) { %>
                        <div>
                            <label for="arquivadaEmDisplay" class="block text-sm font-medium text-gray-600 mb-1">Arquivada Em:</label>
                            <p id="arquivadaEmDisplay" class="mt-1 p-3 border border-gray-200 rounded-md bg-gray-50 text-gray-800 font-medium"><%= formatarDatasParaInput(feiraAtual.arquivadaEm) %></p>
                        </div>
                        <% } %>
                    </div>
                </div>

                <div class="mb-6 bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h4 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-3">Ações da Feira</h4>
                    <div class="flex flex-col md:flex-row gap-4">
                       <form action="/admin/configuracoes/arquivar" method="POST" onsubmit="return confirm('Tem certeza que deseja ARQUIVAR a feira atual? Isso moverá todos os dados para histórico.');">
    <button type="submit" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2.5 px-5 rounded-lg w-full md:w-auto shadow-md transition duration-300 ease-in-out">
        <i class="fas fa-archive mr-2"></i>Arquivar Feira Atual
    </button>
</form>

<form action="/admin/configuracoes/nova" method="POST" onsubmit="return confirm('Tem certeza que deseja iniciar uma NOVA feira? Isso ARQUIVARÁ a feira atual e APAGARÁ os projetos dela.');">
    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2.5 px-5 rounded-lg w-full md:w-auto shadow-md transition duration-300 ease-in-out">
        <i class="fas fa-plus mr-2"></i>Iniciar Nova Feira
    </button>
</form>

<button id="btnAbrirModalConfiguracoes" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2.5 px-5 rounded-lg w-full md:w-auto shadow-md transition duration-300 ease-in-out">
    <i class="fas fa-calendar-alt mr-2"></i>Editar Datas da Feira
</button>

                    </div>
                </div>
            </div>
            <!-- FIM ABA: CONFIGURAÇÕES -->
        </div>
    </div>

    <!-- Modals (permanecem os mesmos) -->
    <div id="modalProjeto" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden justify-center items-center z-50 p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-2xl relative">
            <h2 id="tituloModalProjeto" class="text-3xl font-extrabold mb-6 text-center text-gray-800">Adicionar Novo Projeto</h2>
            <button id="btnFecharModalProjeto" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-4xl leading-none transition duration-300 ease-in-out">&times;</button>

            <form id="formProjeto" action="/admin/projetos" method="POST">
                <input type="hidden" id="projetoId" name="id">

                <div class="mb-4">
                    <label for="titulo" class="block text-gray-700 text-sm font-bold mb-2">Título do Projeto:</label>
                    <input type="text" id="titulo" name="titulo" class="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-150 ease-in-out" required>
                </div>

                <div class="mb-4">
                    <label for="descricao" class="block text-gray-700 text-sm font-bold mb-2">Descrição:</label>
                    <textarea id="descricao" name="descricao" rows="4" class="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-150 ease-in-out"></textarea>
                </div>

                <div class="mb-4">
                    <label for="categoria" class="block text-gray-700 text-sm font-bold mb-2">Categoria:</label>
                    <select id="categoria" name="categoria" class="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-150 ease-in-out" required>
                        <option value="">Selecione uma Categoria</option>
                        <% categorias.forEach(cat => { %>
                            <option value="<%= cat._id %>"><%= cat.nome %></option>
                        <% }) %>
                    </select>
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Critérios de Avaliação:</label>
                    <div id="criteriosProjetoCheckboxes" class="max-h-48 overflow-y-auto border border-gray-300 p-3 rounded-lg bg-gray-50 shadow-inner">
                        <% if (criterios && criterios.length > 0) { %>
                            <% criterios.forEach(criterio => { %>
                                <div class="flex items-center mb-2">
                                    <input type="checkbox" id="criterio_<%= criterio._id %>" name="criterios" value="<%= criterio._id %>" class="mr-2 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <label for="criterio_<%= criterio._id %>" class="text-gray-700 text-base"><%= criterio.nome %> (Peso: <%= criterio.peso %>)</label>
                                </div>
                            <% }) %>
                        <% } else { %>
                            <p class="text-gray-500">Nenhum critério disponível.</p>
                        <% } %>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="turmaProjeto" class="block text-gray-700 text-sm font-bold mb-2">Turma:</label>
                    <input type="text" id="turmaProjeto" name="turma" class="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-150 ease-in-out" required>
                </div>

                <div class="flex items-center justify-end mt-6">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-5 rounded-lg focus:outline-none focus:shadow-outline shadow-md transition duration-300 ease-in-out">
                        <i class="fas fa-save mr-2"></i>Salvar Projeto
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalCategoria" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden justify-center items-center z-50 p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md relative">
            <h2 id="tituloModalCategoria" class="text-3xl font-extrabold mb-6 text-center text-gray-800">Adicionar Nova Categoria</h2>
            <button id="btnFecharModalCategoria" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-4xl leading-none transition duration-300 ease-in-out">&times;</button>
            <form id="formCategoria" action="/admin/categorias" method="POST">
                <input type="hidden" id="categoriaId" name="id">
                <div class="mb-4">
                    <label for="nomeCategoria" class="block text-gray-700 text-sm font-bold mb-2">Nome da Categoria:</label>
                    <input type="text" id="nomeCategoria" name="nome" class="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-150 ease-in-out" required>
                </div>
                <div class="flex items-center justify-end mt-6">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-5 rounded-lg focus:outline-none focus:shadow-outline shadow-md transition duration-300 ease-in-out">
                        <i class="fas fa-save mr-2"></i>Salvar Categoria
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalCriterio" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden justify-center items-center z-50 p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md relative">
            <h2 id="tituloModalCriterio" class="text-3xl font-extrabold mb-6 text-center text-gray-800">Adicionar Novo Critério</h2>
            <button id="btnFecharModalCriterio" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-4xl leading-none transition duration-300 ease-in-out">&times;</button>
            <form id="formCriterio" action="/admin/criterios" method="POST">
                <input type="hidden" id="criterioId" name="id">
                <div class="mb-4">
                    <label for="nomeCriterio" class="block text-gray-700 text-sm font-bold mb-2">Nome do Critério:</label>
                    <input type="text" id="nomeCriterio" name="nome" class="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-150 ease-in-out" required>
                </div>
                <div class="mb-4">
                    <label for="pesoCriterio" class="block text-gray-700 text-sm font-bold mb-2">Peso (1-10):</label>
                    <input type="number" id="pesoCriterio" name="peso" min="1" max="10" class="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-150 ease-in-out" required>
                </div>
                <div class="mb-6">
                    <label for="observacaoCriterio" class="block text-gray-700 text-sm font-bold mb-2">Observações:</label>
                    <textarea id="observacaoCriterio" name="observacao" rows="3" class="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-150 ease-in-out"></textarea>
                </div>
                <div class="flex items-center justify-end gap-4 mt-6">
                    <button type="button" id="btnCancelarModalCriterio" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2.5 px-5 rounded-lg focus:outline-none focus:shadow-outline shadow-md transition duration-300 ease-in-out">
                        <i class="fas fa-times-circle mr-2"></i>Cancelar
                    </button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-5 rounded-lg focus:outline-none focus:shadow-outline shadow-md transition duration-300 ease-in-out">
                        <i class="fas fa-save mr-2"></i>Salvar Critério
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalAvaliador" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden justify-center items-center z-50 p-4">
    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md relative">
        <h2 id="tituloAvaliador" class="text-3xl font-extrabold mb-6 text-center text-gray-800">Adicionar Novo Avaliador</h2>
        <button id="btnFecharAvaliador" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-4xl leading-none transition duration-300 ease-in-out">&times;</button>
        <form id="formAvaliador" action="/admin/avaliadores" method="POST">
            <input type="hidden" id="avaliadorId" name="id">
            <div class="mb-4">
                <label for="nomeAvaliador" class="block text-gray-700 text-sm font-bold mb-2">Nome do Avaliador:</label>
                <input type="text" id="nomeAvaliador" name="nome" class="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-150 ease-in-out" required>
            </div>
            <div class="mb-4">
                <label for="emailAvaliador" class="block text-gray-700 text-sm font-bold mb-2">Email:</label>
                <input type="email" id="emailAvaliador" name="email" class="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-150 ease-in-out" required>
            </div>

            <div class="mb-4">
    <label for="escolaAvaliador" class="block text-gray-700 text-sm font-bold mb-2">Escola:</label>
    <select id="escolaAvaliador" name="escolaId" class="shadow-sm border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-150 ease-in-out">
        <option value="">Selecione a Escola</option>
        <% if (escolas && escolas.length > 0) { %>
            <% escolas.forEach(escola => { %>
                <option value="<%= escola._id %>"><%= escola.nome %></option>
            <% }) %>
        <% } %>
    </select>
</div>

<div class="mb-4">
    <label for="feiraAvaliador" class="block text-gray-700 text-sm font-bold mb-2">Feira:</label>
    <select id="feiraAvaliador" name="feira" class="shadow-sm border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-150 ease-in-out">
        <option value="">Selecione a Feira</option>
        <% if (feiras && feiras.length > 0) { %>
            <% feiras.forEach(feira => { %>
                <option value="<%= feira._id %>"><%= feira.nome %></option>
            <% }) %>
        <% } %>
    </select>
</div>
            <div class="mb-4" id="pinDisplayDiv">
                <label class="block text-gray-700 text-sm font-bold mb-2">PIN:</label>
                <span id="avaliadorPinDisplay" class="block bg-gray-100 p-3 rounded-lg text-xl font-mono tracking-wider text-gray-800 border border-gray-200"></span>
            </div>
            <div class="mb-4 flex items-center">
                <input type="checkbox" id="ativoAvaliador" name="ativo" class="mr-2 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                <label for="ativoAvaliador" class="text-gray-700 text-base font-bold">Ativo</label>
            </div>
            <div class="mb-6">
                <label class="block text-gray-700 text-sm font-bold mb-2">Atribuir Projetos:</label>
                <div id="projetosAvaliadorCheckboxes" class="max-h-48 overflow-y-auto border border-gray-300 p-3 rounded-lg bg-gray-50 shadow-inner">
                    <% if (projetos && projetos.length > 0) { %>
                        <% projetos.forEach(projeto => { %>
                            <div class="flex items-center mb-2">
                                <input type="checkbox" id="projeto_<%= projeto._id %>" name="projetosAtribuidos" value="<%= projeto._id %>" class="mr-2 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <label for="projeto_<%= projeto._id %>" class="text-gray-700 text-base"><%= projeto.titulo %></label>
                            </div>
                        <% }) %>
                    <% } else { %>
                        <p class="text-gray-500">Nenhum projeto disponível.</p>
                    <% } %>
                </div>
            </div>
            <div class="flex items-center justify-end mt-6">
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-5 rounded-lg focus:outline-none focus:shadow-outline shadow-md transition duration-300 ease-in-out">
                    <i class="fas fa-save mr-2"></i>Salvar Avaliador
                </button>
            </div>
        </form>
    </div>
</div>

    <div id="modalFeira" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <form method="POST" action="/admin/feiras" class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md space-y-4">
    <h2 class="text-xl font-bold text-gray-700">Adicionar Nova Feira</h2>
    <input type="text" name="nome" placeholder="Nome da Feira" required class="w-full border border-gray-300 p-2 rounded">
    <input type="text" name="inicioFeira" placeholder="Início (DD-MM-YYYY)" required class="w-full border border-gray-300 p-2 rounded" pattern="\d{2}-\d{2}-\d{4}">
    <input type="text" name="fimFeira" placeholder="Fim (DD-MM-YYYY)" required class="w-full border border-gray-300 p-2 rounded" pattern="\d{2}-\d{2}-\d{4}">
    <div class="flex justify-end space-x-2">
      <button type="button" onclick="fecharModalFeira()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">Cancelar</button>
      <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Salvar</button>
    </div>
  </form>
</div>

<div id="modalEditarFeira" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <form method="POST" action="/admin/feiras/editar" class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md space-y-4">
    <h2 class="text-xl font-bold text-gray-700">Editar Feira</h2>
    <input type="hidden" name="feiraId" id="editarFeiraId">
    <input type="text" name="nome" id="editarFeiraNome" required class="w-full border p-2 rounded" placeholder="Nome da Feira">
    <input type="date" name="inicioFeira" id="editarInicioFeira" required class="w-full border p-2 rounded">
    <input type="date" name="fimFeira" id="editarFimFeira" required class="w-full border p-2 rounded">
    <select name="status" id="editarFeiraStatus" class="w-full border p-2 rounded">
      <option value="ativa">Ativa</option>
      <option value="arquivada">Arquivada</option>
    </select>
    <div class="flex justify-end items-center pt-4">
      <button type="button" onclick="fecharModalEditarFeira()" class="bg-gray-500 text-white px-4 py-2 rounded">Cancelar</button>
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded ml-2">Salvar</button>
    </div>
  </form>
</div>

        <!-- Formulário oculto para exclusão -->
<form id="formExcluirFeira" action="/admin/feiras/excluir" method="POST" class="hidden">
  <input type="hidden" name="feiraId" id="excluirFeiraHidden">
</form>

<!-- Botão que dispara a exclusão -->
<button type="button" onclick="confirmarExclusaoFeira()" class="bg-red-600 text-white px-4 py-2 rounded">Excluir</button>

      </div>
    </div>
  </form>
</div>

    <div id="modalConfiguracoes" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden justify-center items-center z-50 p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md relative">
            <h2 class="text-3xl font-extrabold mb-6 text-center text-gray-800">Editar Datas da Feira</h2>
            <button id="btnFecharModalConfiguracoes" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-4xl leading-none transition duration-300 ease-in-out">&times;</button>
            <form action="/admin/configuracoes/feiradata" method="POST"> 
                <input type="hidden" name="feiraId" value="<%= feiraAtual._id %>"> 
                <div class="mb-4">
                    <label for="inicioFeira" class="block text-gray-700 text-sm font-bold mb-2">Início da Feira:</label>
                    <input type="date" id="inicioFeira" name="inicioFeira" class="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-150 ease-in-out" value="<%= feiraAtual.inicioFeira ? formatarDatasParaInput(feiraAtual.inicioFeira) : '' %>">
                </div>
                <div class="mb-4">
                    <label for="fimFeira" class="block text-gray-700 text-sm font-bold mb-2">Fim da Feira:</label>
                    <input type="date" id="fimFeira" name="fimFeira" class="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-150 ease-in-out" value="<%= feiraAtual.fimFeira ? formatarDatasParaInput(feiraAtual.fimFeira) : '' %>">
                </div>
                <div class="flex items-center justify-end mt-6">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-5 rounded-lg focus:outline-none focus:shadow-outline shadow-md transition duration-300 ease-in-out">
                        <i class="fas fa-save mr-2"></i>Salvar Datas
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const contentArea = document.getElementById('contentArea');
            const tabLinks = document.querySelectorAll('.sidebar-link');
            const tabContents = document.querySelectorAll('.tab-content');

            // Função para ativar a aba
            const activateTab = (tabId) => {
                tabLinks.forEach(link => {
                    link.classList.remove('active');
                });
                tabContents.forEach(content => {
                    content.classList.add('hidden');
                });

                const activeLink = document.querySelector(`.sidebar-link[data-tab="${tabId}"]`);
                const activeContent = document.getElementById(tabId);

                if (activeLink) {
                    activeLink.classList.add('active');
                }
                if (activeContent) {
                    activeContent.classList.remove('hidden');
                }
            };

            // Lógica para abas e URL
            const urlParams = new URLSearchParams(window.location.search);
            const initialTabFromUrl = urlParams.get('tab');
            const savedTab = localStorage.getItem('activeTab');

            const initialTab = initialTabFromUrl || savedTab || 'dashboard-geral';
            activateTab(initialTab);

            tabLinks.forEach(link => {
                link.addEventListener('click', (event) => {
                    event.preventDefault(); // Impede o comportamento padrão do link
                    const tabId = link.dataset.tab;
                    activateTab(tabId);
                    localStorage.setItem('activeTab', tabId);
                    // Atualiza a URL para que a aba seja mantida em caso de recarga
                    const newUrl = new URL(window.location.href);
                    newUrl.searchParams.set('tab', tabId);
                    window.history.pushState({ path: newUrl.href }, '', newUrl.href);
                });
            });

            // Lógica para recolher/expandir o sidebar
            // Verifica a largura da tela ao carregar e ajusta o sidebar
            const applySidebarState = () => {
                if (window.innerWidth <= 768) { // Ex: para telas menores que md
                    sidebar.classList.remove('collapsed');
                    sidebar.classList.remove('show');
                    contentArea.style.marginLeft = '0px';
                    // Talvez esconder o toggle button ou mudá-lo para um menu hamburger flutuante
                } else {
                    const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
                    if (isCollapsed) {
                        sidebar.classList.add('collapsed');
                        contentArea.style.marginLeft = '64px'; // Largura do sidebar colapsado
                    } else {
                        sidebar.classList.remove('collapsed');
                        contentArea.style.marginLeft = '250px'; // Largura do sidebar expandido
                    }
                     sidebar.classList.remove('show'); // Remove a classe 'show' se estiver em desktop
                }
            };

            // Aplica o estado inicial do sidebar
            applySidebarState();

            // Adiciona evento de clique para o botão de toggle
            sidebarToggle.addEventListener('click', () => {
                const isCurrentlyCollapsed = sidebar.classList.toggle('collapsed');
                localStorage.setItem('sidebarCollapsed', isCurrentlyCollapsed);
                // Ajusta a margem do conteúdo principal
                if (isCurrentlyCollapsed) {
                    contentArea.style.marginLeft = '64px';
                } else {
                    contentArea.style.marginLeft = '250px';
                }
            });

            // Adiciona um listener para redimensionamento de janela
            window.addEventListener('resize', applySidebarState);


            // Funções para os modais (permanecem as mesmas)

            // Mostrar modal de Projeto
            const modalProjeto = document.getElementById('modalProjeto');
            const btnAbrirModalProjeto = document.getElementById('btnAbrirModalProjeto');
            const btnFecharModalProjeto = document.getElementById('btnFecharModalProjeto');
            const formProjeto = document.getElementById('formProjeto');
            const tituloModalProjeto = document.getElementById('tituloModalProjeto');
            const projetoId = document.getElementById('projetoId');
            const inputTitulo = document.getElementById('titulo');
            const inputDescricao = document.getElementById('descricao');
            const selectCategoria = document.getElementById('categoria');
            const criteriosProjetoCheckboxesDiv = document.getElementById('criteriosProjetoCheckboxes');
            const inputTurmaProjeto = document.getElementById('turmaProjeto');

            btnAbrirModalProjeto.addEventListener('click', () => {
                tituloModalProjeto.textContent = 'Adicionar Novo Projeto';
                formProjeto.action = '/admin/projetos'; // Rota de criação
                projetoId.value = '';
                inputTitulo.value = '';
                inputDescricao.value = '';
                selectCategoria.value = '';
                inputTurmaProjeto.value = '';

                // Limpar todos os checkboxes de critérios
                criteriosProjetoCheckboxesDiv.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });

                modalProjeto.classList.remove('hidden');
                modalProjeto.classList.add('flex');
            });

            btnFecharModalProjeto.addEventListener('click', () => {
                modalProjeto.classList.remove('flex');
                modalProjeto.classList.add('hidden');
            });

            document.querySelectorAll('.btn-editar-projeto').forEach(button => {
                button.addEventListener('click', (event) => {
                    tituloModalProjeto.textContent = 'Editar Projeto';
                    formProjeto.action = `/admin/projetos/${event.target.dataset.id}?_method=PUT`; // Rota de edição
                    projetoId.value = event.target.dataset.id;
                    inputTitulo.value = event.target.dataset.titulo;
                    inputDescricao.value = event.dataset.descricao; // Use .dataset.descricao
                    selectCategoria.value = event.target.dataset.categoriaId;
                    inputTurmaProjeto.value = event.target.dataset.turma;

                    // Marcar checkboxes de critérios
                    const criteriosIds = event.target.dataset.criterios ? event.target.dataset.criterios.split(',') : [];
                    criteriosProjetoCheckboxesDiv.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                        checkbox.checked = criteriosIds.includes(checkbox.value);
                    });

                    modalProjeto.classList.remove('hidden');
                    modalProjeto.classList.add('flex');
                });
            });

            // Mostrar modal de Categoria
            const modalCategoria = document.getElementById('modalCategoria');
            const btnAbrirModalCategoria = document.getElementById('btnAbrirModalCategoria');
            const btnFecharModalCategoria = document.getElementById('btnFecharModalCategoria');
            const formCategoria = document.getElementById('formCategoria');
            const tituloModalCategoria = document.getElementById('tituloModalCategoria');
            const categoriaId = document.getElementById('categoriaId');
            const inputNomeCategoria = document.getElementById('nomeCategoria');

            btnAbrirModalCategoria.addEventListener('click', () => {
                tituloModalCategoria.textContent = 'Adicionar Nova Categoria';
                formCategoria.action = '/admin/categorias'; // Rota de criação
                categoriaId.value = '';
                inputNomeCategoria.value = '';
                modalCategoria.classList.remove('hidden');
                modalCategoria.classList.add('flex');
            });

            btnFecharModalCategoria.addEventListener('click', () => {
                modalCategoria.classList.remove('flex');
                modalCategoria.classList.add('hidden');
            });

            document.querySelectorAll('.btn-editar-categoria').forEach(button => {
                button.addEventListener('click', (event) => {
                    tituloModalCategoria.textContent = 'Editar Categoria';
                    formCategoria.action = `/admin/categorias/${event.target.dataset.id}?_method=PUT`; // Rota de edição
                    categoriaId.value = event.target.dataset.id;
                    inputNomeCategoria.value = event.target.dataset.nome;
                    modalCategoria.classList.remove('hidden');
                    modalCategoria.classList.add('flex');
                });
            });

            // Mostrar modal de Critério
            const modalCriterio = document.getElementById('modalCriterio');
            const btnAbrirModalCriterio = document.getElementById('btnAbrirModalCriterio');
            const btnFecharModalCriterio = document.getElementById('btnFecharModalCriterio');
            const btnCancelarModalCriterio = document.getElementById('btnCancelarModalCriterio');
            const formCriterio = document.getElementById('formCriterio');
            const tituloModalCriterio = document.getElementById('tituloModalCriterio');
            const criterioId = document.getElementById('criterioId');
            const inputNomeCriterio = document.getElementById('nomeCriterio');
            const inputPesoCriterio = document.getElementById('pesoCriterio');
            const inputObservacaoCriterio = document.getElementById('observacaoCriterio');


            btnAbrirModalCriterio.addEventListener('click', () => {
                tituloModalCriterio.textContent = 'Adicionar Novo Critério';
                formCriterio.action = '/admin/criterios'; // Rota de criação
                criterioId.value = '';
                inputNomeCriterio.value = '';
                inputPesoCriterio.value = '';
                inputObservacaoCriterio.value = '';
                modalCriterio.classList.remove('hidden');
                modalCriterio.classList.add('flex');
            });

            btnFecharModalCriterio.addEventListener('click', () => {
                modalCriterio.classList.remove('flex');
                modalCriterio.classList.add('hidden');
            });

            btnCancelarModalCriterio.addEventListener('click', () => {
                modalCriterio.classList.remove('flex');
                modalCriterio.classList.add('hidden');
            });

            document.querySelectorAll('.btn-editar-criterio').forEach(button => {
                button.addEventListener('click', (event) => {
                    tituloModalCriterio.textContent = 'Editar Critério';
                    formCriterio.action = `/admin/criterios/${event.target.dataset.id}?_method=PUT`; // Rota de edição
                    criterioId.value = event.target.dataset.id;
                    inputNomeCriterio.value = event.target.dataset.nome;
                    inputPesoCriterio.value = event.target.dataset.peso;
                    inputObservacaoCriterio.value = event.target.dataset.observacao;
                    modalCriterio.classList.remove('hidden');
                    modalCriterio.classList.add('flex');
                });
            });

            // Mostrar modal de Avaliador
            const modalAvaliador = document.getElementById('modalAvaliador');
            const btnAbrirModalAvaliador = document.getElementById('btnAbrirModalAvaliador');
            const btnFecharAvaliador = document.getElementById('btnFecharAvaliador');
            const formAvaliador = document.getElementById('formAvaliador');
            const tituloAvaliador = document.getElementById('tituloAvaliador');
            const avaliadorId = document.getElementById('avaliadorId');
            const inputNomeAvaliador = document.getElementById('nomeAvaliador');
            const inputEmailAvaliador = document.getElementById('emailAvaliador');
            const inputAtivoAvaliador = document.getElementById('ativoAvaliador');
            const avaliadorPinDisplay = document.getElementById('avaliadorPinDisplay');
            const pinDisplayDiv = document.getElementById('pinDisplayDiv');
            const projetosAvaliadorCheckboxesDiv = document.getElementById('projetosAvaliadorCheckboxes');

            btnAbrirModalAvaliador.addEventListener('click', () => {
                tituloAvaliador.textContent = 'Adicionar Novo Avaliador';
                formAvaliador.action = '/admin/avaliadores'; // Rota de criação
                avaliadorId.value = '';
                inputNomeAvaliador.value = '';
                inputEmailAvaliador.value = '';
                inputAtivoAvaliador.checked = true; // Novo avaliador é ativo por padrão
                avaliadorPinDisplay.textContent = 'Gerado Automaticamente';
                pinDisplayDiv.classList.remove('hidden'); // Esconde o PIN para novos

                // Limpar todos os checkboxes de projetos
                projetosAvaliadorCheckboxesDiv.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });

                modalAvaliador.classList.remove('hidden');
                modalAvaliador.classList.add('flex');
            });

            btnFecharAvaliador.addEventListener('click', () => {
                modalAvaliador.classList.remove('flex');
                modalAvaliador.classList.add('hidden');
            });

            document.querySelectorAll('.btn-editar-avaliador').forEach(button => {
                button.addEventListener('click', (event) => {
                    tituloAvaliador.textContent = 'Editar Avaliador';
                    formAvaliador.action = `/admin/avaliadores/${event.target.dataset.id}?_method=PUT`; // Rota de edição
                    avaliadorId.value = event.target.dataset.id;
                    inputNomeAvaliador.value = event.target.dataset.nome;
                    inputEmailAvaliador.value = event.target.dataset.email;
                    inputAtivoAvaliador.checked = event.target.dataset.ativo === 'true';
                    avaliadorPinDisplay.textContent = event.target.dataset.pin;
                    pinDisplayDiv.classList.remove('hidden'); // Mostra o PIN para edição

                    // Marcar checkboxes de projetos
                    const projetosIds = event.target.dataset.projetos ? event.target.dataset.projetos.split(',') : [];
                    projetosAvaliadorCheckboxesDiv.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                        checkbox.checked = projetosIds.includes(checkbox.value);
                    });

                    modalAvaliador.classList.remove('hidden');
                    modalAvaliador.classList.add('flex');
                });
            });

            // Mostrar modal de Feira
            const modalFeira = document.getElementById('modalFeira');
            const btnAbrirModalFeira = document.getElementById('btnAbrirModalFeira');
            const btnFecharModalFeira = document.getElementById('btnFecharModalFeira');
            const formFeira = document.getElementById('formFeira');
            const tituloModalFeira = document.getElementById('tituloModalFeira');
            const feiraId = document.getElementById('feiraId');
            const inputNomeFeira = document.getElementById('nomeFeira');
            const inputInicioFeiraModal = document.getElementById('inicioFeiraModal');
            const inputFimFeiraModal = document.getElementById('fimFeiraModal');
            const selectStatusFeiraModal = document.getElementById('statusFeiraModal');

            btnAbrirModalFeira.addEventListener('click', () => {
                tituloModalFeira.textContent = 'Adicionar Nova Feira';
                formFeira.action = '/admin/feiras'; // Rota de criação (ajustei para /admin/feiras conforme seu admin.js)
                feiraId.value = '';
                inputNomeFeira.value = '';
                inputInicioFeiraModal.value = '';
                inputFimFeiraModal.value = '';
                selectStatusFeiraModal.value = 'ativa'; // Nova feira é ativa por padrão
                modalFeira.classList.remove('hidden');
                modalFeira.classList.add('flex');
            });

            btnFecharModalFeira.addEventListener('click', () => {
                modalFeira.classList.remove('flex');
                modalFeira.classList.add('hidden');
            });

            // ✅ Abrir modal e preencher dados
  document.querySelectorAll('.btn-editar-feira').forEach(btn => {
    btn.addEventListener('click', () => {
      document.getElementById('editarFeiraId').value = btn.dataset.id;
      document.getElementById('editarFeiraNome').value = btn.dataset.nome;
      document.getElementById('editarInicioFeira').value = btn.dataset.inicio.split('-').reverse().join('-');
      document.getElementById('editarFimFeira').value = btn.dataset.fim.split('-').reverse().join('-');
      document.getElementById('editarFeiraStatus').value = btn.dataset.status;
      document.getElementById('excluirFeiraId').value = btn.dataset.id;
      document.getElementById('modalEditarFeira').classList.remove('hidden');
    });
  });

            // Mostrar modal de Configurações (apenas datas)
            const modalConfiguracoes = document.getElementById('modalConfiguracoes');
            const btnAbrirModalConfiguracoes = document.getElementById('btnAbrirModalConfiguracoes');
            const btnFecharModalConfiguracoes = document.getElementById('btnFecharModalConfiguracoes');

            btnAbrirModalConfiguracoes.addEventListener('click', () => {
                modalConfiguracoes.classList.remove('hidden');
                modalConfiguracoes.classList.add('flex');
            });

            btnFecharModalConfiguracoes.addEventListener('click', () => {
                modalConfiguracoes.classList.remove('flex');
                modalConfiguracoes.classList.add('hidden');
            });
        });

        // Função auxiliar para formatar datas (se já não estiver definida globalmente)
        function formatarDatasParaInput(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${day}-${month}-${year}`;
        }

        document.getElementById('btnAbrirModalFeira').addEventListener('click', function () {
        document.getElementById('modalFeira').classList.remove('hidden');
        });
        function fecharModalFeira() {
        document.getElementById('modalFeira').classList.add('hidden');
        }

        // ✅ Abrir modal e preencher dados
  document.querySelectorAll('.btn-editar-feira').forEach(btn => {
    btn.addEventListener('click', () => {
      document.getElementById('editarFeiraId').value = btn.dataset.id;
      document.getElementById('editarFeiraNome').value = btn.dataset.nome;
      document.getElementById('editarInicioFeira').value = btn.dataset.inicio.split('-').reverse().join('-');
      document.getElementById('editarFimFeira').value = btn.dataset.fim.split('-').reverse().join('-');
      document.getElementById('modalEditarFeira').classList.remove('hidden');
    });
  });

  function fecharModalEditarFeira() {
    document.getElementById('modalEditarFeira').classList.add('hidden');
  }
  function confirmarExclusaoFeira() {
  if (confirm('Deseja realmente excluir esta feira?')) {
    document.getElementById('excluirFeiraHidden').value = document.getElementById('editarFeiraId').value;
    document.getElementById('formExcluirFeira').submit();
  }
}

    </script>
</body>
</html>

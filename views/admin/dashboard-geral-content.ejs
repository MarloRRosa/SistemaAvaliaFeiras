<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard da Feira</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
    }
    th, td {
      padding: 0.75rem;
      text-align: left;
      vertical-align: top;
      border-bottom: 1px solid #e2e8f0;
    }
    th {
      background-color: #f8fafc;
      font-weight: 600;
      color: #4a5568;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
  </style>
</head>
<body class="min-h-screen p-8 font-sans antialiased text-gray-800">

  <header class="text-center mb-12">
    <h1 class="text-4xl font-light text-gray-800 tracking-wide">Dashboard Geral da Feira</h1>
    <p class="text-lg text-gray-600 mt-2">Visão consolidada dos dados da feira</p>
  </header>

  <form id="reportForm" action="" method="GET" target="_blank" class="max-w-4xl mx-auto mb-12 text-center">
    <label for="tipoRelatorio" class="text-lg font-medium text-gray-700 mr-2">Escolha o relatório:</label>
    <select name="tipo" id="tipoRelatorio" class="border border-gray-300 rounded px-3 py-2 text-gray-800">
      <option value="">-- Selecione um relatório --</option>
      <option value="/admin/relatorio-consolidado/pdf">Relatório Consolidado (PDF)</option>
      <option value="/admin/resultados-finais/pdf">Resultados Finais (PDF)</option>
      <option value="/admin/ranking-categorias/pdf">Ranking por Categoria (PDF)</option>
      <option value="/admin/avaliacoes/pdf">Avaliações Detalhadas (PDF)</option>
      <option value="/admin/resumo-avaliadores/pdf">Resumo por Avaliador (PDF)</option>
      <option value="/admin/projetos-sem-avaliacao/pdf">Projetos sem Avaliação (PDF)</option>
    </select>
    <button type="submit" class="ml-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
      Gerar Relatório
    </button>
  </form>

  <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
      <h2 class="text-xl font-semibold text-indigo-600 mb-4">Projetos por Categoria</h2>
      <ul class="space-y-2 text-gray-700 text-base">
        <% if (Object.keys(projetosPorCategoria).length > 0) { %>
          <% Object.keys(projetosPorCategoria).sort().forEach(categoria => { %>
            <li class="flex justify-between items-center">
              <span><%= categoria %></span>
              <span class="font-medium bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm">
                <%= projetosPorCategoria[categoria].length %>
              </span>
            </li>
          <% }) %>
        <% } else { %>
          <li>Nenhuma categoria ou projeto encontrado.</li>
        <% } %>
      </ul>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
      <h2 class="text-xl font-semibold text-green-600 mb-4">Avaliadores Registrados</h2>
      <p class="text-base text-gray-700">
        Total: <span class="font-medium text-green-700"><%= avaliadores.length %></span>
      </p>
      <p class="text-base text-gray-700">
        Ativos: <span class="font-medium text-green-500"><%= avaliadores.filter(a => a.ativo).length %></span>
      </p>
      <p class="text-base text-gray-700">
        Inativos: <span class="font-medium text-red-500"><%= avaliadores.filter(a => !a.ativo).length %></span>
      </p>
    </div>

  </div>

  <div class="max-w-6xl mx-auto mt-8 bg-white p-6 rounded-xl shadow-md border border-gray-200">
    <h2 class="text-2xl font-semibold text-blue-600 mb-6 text-center">Resultados de Avaliação por Projeto</h2>
    
    <% if (Object.keys(relatorioFinalPorProjeto).length > 0) { %>
      <% Object.keys(relatorioFinalPorProjeto).sort().forEach(categoria => { %>
        <h3 class="text-xl font-bold text-gray-800 mt-8 mb-4 border-b-2 pb-2 border-blue-200"><%= categoria %></h3>
        <div class="overflow-x-auto">
          <table class="min-w-full bg-white shadow-sm rounded-lg">
            <thead>
              <tr>
                <th class="py-3 px-4 uppercase font-semibold text-sm text-gray-600">Projeto</th>
                <th class="py-3 px-4 uppercase font-semibold text-sm text-gray-600 text-center">Nº Avaliações</th>
                <% criteriosOficiais.forEach(criterio => { %>
                  <th class="py-3 px-4 uppercase font-semibold text-sm text-gray-600 text-center"><%= criterio.nome %></th>
                <% }) %>
                <th class="py-3 px-4 uppercase font-semibold text-sm text-gray-600 text-center">Média Geral</th>
              </tr>
            </thead>
            <tbody>
              <% relatorioFinalPorProjeto[categoria].forEach(projeto => { %>
                <tr class="hover:bg-gray-50">
                  <td class="py-3 px-4 text-gray-700"><%= projeto.titulo %></td>
                  <td class="py-3 px-4 text-gray-700 text-center"><%= projeto.numAvaliacoes %></td>
                  <% criteriosOficiais.forEach(criterio => { %>
                    <td class="py-3 px-4 text-gray-700 text-center">
                      <%= projeto.mediasCriterios[criterio._id.toString()] %>
                    </td>
                  <% }) %>
                  <td class="py-3 px-4 text-gray-800 font-bold text-center">
                    <%= projeto.mediaGeral %>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      <% }) %>
    <% } else { %>
      <p class="text-center text-gray-600 py-8">Nenhum projeto avaliado nesta feira ainda.</p>
    <% } %>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const reportForm = document.getElementById('reportForm');
      const tipoRelatorioSelect = document.getElementById('tipoRelatorio');

      // Inicializa a ação do formulário com base na seleção padrão (se houver)
      if (tipoRelatorioSelect.value) {
        reportForm.action = tipoRelatorioSelect.value;
      }

      tipoRelatorioSelect.addEventListener('change', function() {
        reportForm.action = this.value;
      });

      reportForm.addEventListener('submit', function(event) {
        if (!tipoRelatorioSelect.value) {
          event.preventDefault(); // Impede o envio se nenhuma opção for selecionada
          alert('Por favor, selecione um tipo de relatório para gerar.'); // Use um modal personalizado se preferir
        }
      });
    });

    // Esta função formatarData é utilizada no EJS para exibir datas
    // É importante que ela esteja disponível no escopo onde o EJS é renderizado
    // (no caso, dashboard-geral-content.ejs é incluído no dashboard.ejs,
    // então a função deve estar definida no dashboard.ejs ou de forma global acessível)
    // Se você já tem uma função formatarDatasParaInput em dashboard.ejs, remova ou ajuste aqui.
    function formatarData(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${day}/${month}/${year}`; // Formato DD/MM/AAAA para exibição
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Relatório de Avaliações</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      color: #333;
    }

    h1, h2, h3 {
      color: #222;
    }

    .projeto-section {
      page-break-before: always; /* cada projeto inicia em nova página */
      margin-bottom: 40px;
    }

    .avaliacao-header {
      background: #f0f0f0;
      padding: 12px;
      border-radius: 5px;
      margin-bottom: 15px;
      font-size: 18px;
    }

    .avaliacao-section {
      margin-bottom: 30px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background-color: #f9f9f9;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.05);
      page-break-inside: avoid; /* evita quebrar avaliação no meio */
    }

    .avaliacao-details p {
      margin: 4px 0;
    }

    .criterios-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    .criterios-table th,
    .criterios-table td {
      border: 1px solid #ccc;
      padding: 8px;
    }

    .criterios-table th {
      background: #eee;
      text-align: left;
    }

    .text-center {
      text-align: center;
    }

    .status-finalizada {
      color: green;
    }

    .status-pendente {
      color: red;
    }

    @media print {
      body {
        margin: 10mm;
      }
      .projeto-section {
        page-break-before: always;
      }
      .avaliacao-section {
        page-break-inside: avoid;
      }
    }
  </style>
</head>
<body>
  <h1>Relatório de Avaliações</h1>

  <% 
    const avaliacoesPorProjeto = {};
    avaliacoes.forEach(av => {
      const projetoId = av.projeto ? av.projeto._id : 'semProjeto';
      if (!avaliacoesPorProjeto[projetoId]) {
        avaliacoesPorProjeto[projetoId] = {
          projeto: av.projeto,
          avaliacoes: []
        };
      }
      avaliacoesPorProjeto[projetoId].avaliacoes.push(av);
    });
  %>

  <% Object.keys(avaliacoesPorProjeto).forEach(projetoId => { 
      const projetoData = avaliacoesPorProjeto[projetoId];
  %>
    <div class="projeto-section">
      <h2 class="avaliacao-header">
        Projeto: <%= projetoData.projeto && projetoData.projeto.titulo ? projetoData.projeto.titulo : 'Projeto Removido' %> 
        (<%= projetoData.projeto && projetoData.projeto.categoria ? projetoData.projeto.categoria.nome : 'Sem Categoria' %>)
      </h2>

      <% projetoData.avaliacoes.forEach(avaliacao => { %>
        <div class="avaliacao-section">
          <div class="avaliacao-details">
            <p>Avaliador: <strong>
              <%= avaliacao.avaliador && avaliacao.avaliador.nome ? avaliacao.avaliador.nome : 'Avaliador Removido' %>
              (<%= avaliacao.avaliador && avaliacao.avaliador.email ? avaliacao.avaliador.email : '-' %>)
            </strong></p>
            <p>Data da Avaliação: <strong><%= formatarData(avaliacao.createdAt) %></strong></p>
            <p>Status: <strong class="<%= avaliacao.finalizadaPorAvaliador ? 'status-finalizada' : 'status-pendente' %>">
              <%= avaliacao.finalizadaPorAvaliador ? 'Finalizada' : 'Em Andamento' %>
            </strong></p>
            <% if (avaliacao.comentarioGeral && avaliacao.comentarioGeral.trim() !== '') { %>
              <p>Comentário Geral: <em><%= avaliacao.comentarioGeral %></em></p>
            <% } %>
          </div>

          <% if (avaliacao.notasComNomesDeCriterio && avaliacao.notasComNomesDeCriterio.length > 0) { %>
            <table class="criterios-table">
              <thead>
                <tr>
                  <th>Critério</th>
                  <th class="text-center">Nota</th>
                  <th>Observações</th>
                </tr>
              </thead>
              <tbody>
                <% avaliacao.notasComNomesDeCriterio.forEach(nota => { %>
                  <tr>
                    <td><%= nota.criterioNome %></td>
                    <td class="text-center"><%= nota.valor %></td>
                    <td><%= nota.observacao || 'Nenhuma' %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          <% } else { %>
            <p>Nenhuma nota de critério registrada para esta avaliação.</p>
          <% } %>
        </div>
      <% }) %>
    </div>
  <% }) %>

</body>
</html>
